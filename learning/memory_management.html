<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-learning docs-doc-id-memory_management">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-91G2XYQTXS"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-91G2XYQTXS",{})</script><title data-rh="true">Работа с памятью | Kotlin Multiplatform Mobile</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kmm.icerock.dev/learning/memory_management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-learning-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-learning-current"><meta data-rh="true" property="og:title" content="Работа с памятью | Kotlin Multiplatform Mobile"><meta data-rh="true" name="description" content="Оперативная память (RAM - память с произвольным доступом) - используется центральным процессором, чтобы загрузить в нее операционную систему, как android, так и ios. При запуске приложения для него выделяется некоторый объем оперативной памяти, он называется памятью кучи (heap). При создании объекта (экземпляра класса) под него выделяется участок памяти в куче. Этот процесс осуществляется во время выполнения программы, поэтому такое выделение памяти называют динамическим. Созданный объект получает ссылку - переменную, содержащую адрес ячейки памяти, в которой он хранится."><meta data-rh="true" property="og:description" content="Оперативная память (RAM - память с произвольным доступом) - используется центральным процессором, чтобы загрузить в нее операционную систему, как android, так и ios. При запуске приложения для него выделяется некоторый объем оперативной памяти, он называется памятью кучи (heap). При создании объекта (экземпляра класса) под него выделяется участок памяти в куче. Этот процесс осуществляется во время выполнения программы, поэтому такое выделение памяти называют динамическим. Созданный объект получает ссылку - переменную, содержащую адрес ячейки памяти, в которой он хранится."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kmm.icerock.dev/learning/memory_management"><link data-rh="true" rel="alternate" href="https://kmm.icerock.dev/learning/memory_management" hreflang="en"><link data-rh="true" rel="alternate" href="https://kmm.icerock.dev/learning/memory_management" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.893f3d2c.css">
<link rel="preload" href="/assets/js/runtime~main.b7be8930.js" as="script">
<link rel="preload" href="/assets/js/main.46935d83.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Home</b></a><a class="navbar__item navbar__link" href="/onboarding/intro">Onboarding</a><a class="navbar__item navbar__link navbar__link--active" href="/learning/intro">Knowledge Base</a><a class="navbar__item navbar__link" href="/university/intro">University</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/icerockdev/kmm.icerock.dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/intro">О разделе</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/code-style/general-rules">CodeStyle</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/gradle/intro-gradle">Gradle</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/android/study-materials">Android</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/ios/study-materials">iOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin/study-materials">Kotlin</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin-multiplatform/how-to-start">Kotlin Multiplatform</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin-native/summary">Kotlin/Native</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/libraries/kotlinx/coroutines">Библиотеки</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/problem-solving/gradle-daemon-crash">Решения проблем</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/learning/memory_management">Работа с памятью</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/concurrency">Многопоточность</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/state">Единый стейт экрана</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/socket">Socket</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/links">Ссылки</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/code">Примеры кода</a></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Работа с памятью</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_bZGK theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_l22C">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Работа с памятью</h1><p>Оперативная память (RAM - память с произвольным доступом) - используется центральным процессором, чтобы загрузить в нее операционную систему, как android, так и ios. При запуске приложения для него выделяется некоторый объем оперативной памяти, он называется памятью кучи (heap). При создании объекта (экземпляра класса) под него выделяется участок памяти в куче. Этот процесс осуществляется во время выполнения программы, поэтому такое выделение памяти называют динамическим. Созданный объект получает ссылку - переменную, содержащую адрес ячейки памяти, в которой он хранится.
Пример создания объекта на Kotlin:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">class Cat {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    val name: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val murzik = Cat()</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Переменная murzik хранит ссылку на объект класса Cat.</p><p>Объекты, созданные в куче, имеют глобальный доступ и на них могут ссылаться из любой части приложения. По мере создания новых объектов количество доступной памяти уменьшается. Поэтому необходимо постоянно освобождать ранее выделенную память.
Для управления динамическим распределением памяти используется сборщик мусора — программный объект, который следит за выделением памяти и обеспечивает её своевременное освобождение. Сборщик мусора на андроиде (Garbage Collector) и механизм автоматического подсчета ссылок (Automatic Reference Counting) на iOS объединены общей целью, но подходят к решению этой задачи по-разному. Они должны находить мусор - неиспользуемые объекты - и освобождать от них память. </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="однако-что-считается-мусором">Однако что считается “мусором”?<a class="hash-link" href="#однако-что-считается-мусором" title="Direct link to heading">​</a></h2><p>Объект считается неиспользуемым, если он становится недостижим: это значит, что на него не остается сильных ссылок (подход ARC и GC), либо цепочка сильных ссылок, которая могла бы связать объект с другими объектами, обрывается (подход GC).</p><p><img loading="lazy" alt="Иллюстрация" src="/assets/images/gc-f1ce86f0b4235f1b4cec861f0007b7b1.jpg" width="600" height="280" class="img_E7b_"></p><p>Вернёмся к переменной murzik, которая все еще хранит ссылку на объект класса Cat. Если присвоить переменной murzik значение null, она перестанет ссылаться на объект, хранящийся в памяти:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">murzik = null</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Объект класса Cat становится недостижим, мы больше не можем получить его по ссылке murzik. Теперь он может быть удален из памяти сборщиком мусора.</p><p>Рассмотрим каждый подход подробнее.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="механизм-автоматического-подсчета-ссылок">Механизм автоматического подсчета ссылок<a class="hash-link" href="#механизм-автоматического-подсчета-ссылок" title="Direct link to heading">​</a></h2><p>Каждый объект имеет счетчик, который хранит информацию о том, сколько ссылок указывает на объект. Когда ссылка уничтожается, счетчик уменьшается. Если значение счетчика равно нулю, то объект можно считать мусором. ARC не освободит экземпляр, если на него есть хотя бы одна сильная ссылка. Главным минусом такого подхода является сложность обеспечения точности счетчика. Также при таком подходе сложно выявлять циклические зависимости (когда два объекта больше не используются, но каждый из них ссылается на другой). Это приводит к утечкам памяти: такую память невозможно освободить и выделить под другие объекты.</p><p><img loading="lazy" alt="Иллюстрация" src="/assets/images/reference-b884dd1b30cd7bc3953612f70aeee675.png" width="521" height="213" class="img_E7b_"></p><p><a href="https://swiftbook.ru/content/languageguide/automatic-reference-counting/#strong-reference-cycles-between-class-instances" target="_blank" rel="noopener noreferrer">Наглядный пример цикла сильных ссылок на iOS</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="подход-garbage-collector-на-андроид">Подход Garbage Collector на андроид<a class="hash-link" href="#подход-garbage-collector-на-андроид" title="Direct link to heading">​</a></h2><p>В Андроид байт-код исполняет своя виртуальная java машина – ART (Android Runtime). Поэтому реализация сборщика мусора схожа с реализацией GC в JVM.</p><p>Его работа будет запущена в следующих случаях:</p><ul><li>когда возникнет условие нехватки памяти (невозможно провести операцию по выделению памяти)</li><li>когда заполнение памяти кучи достигнет определенного лимита </li><li>когда сборщик мусора был вызван непосредственно из кода программы</li></ul><p><a href="http://alexandr.logdown.com/posts/22570" target="_blank" rel="noopener noreferrer">Как работает последовательный сборщик мусора (генерационный)</a>
Такой сборщик мусора в своей работе использует модель stop-the-world, останавливая работу приложения на время, необходимое для полного прохождения цикла сборки мусора. Сборка мусора выполняется только одним потоком.</p><p>Также существует параллельный сборщик мусора <strong>Concurrent Mark Sweep GC</strong>
Выполняет часть работ по сборке мусора параллельно с основными потоками приложения.</p><p><strong>Алгоритм его работы можно описать так:</strong></p><ul><li>Объекты создаются в памяти;</li><li>В момент, когда нужно запустить сборщик мусора приложение приостанавливается;</li><li>Сборщик проходится по дереву объектов, помечая живые объекты;</li><li>Сборщик проходится по всей памяти, находя все не отмеченные куски памяти и сохраняя их в «free list»;</li><li>Когда новые объекты начинают создаваться, они создаются в памяти доступной во «free list».</li></ul><p><strong>Минусы этого способа:</strong></p><ul><li>Приложение не работает, пока происходит сборка мусора;</li><li>Время остановки напрямую зависит от размеров памяти и количества объектов</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="вернемся-к-подходу-gc-на-андроид-что-же-он-считает-мусором">Вернемся к подходу GC на андроид, что же он считает “мусором”?<a class="hash-link" href="#вернемся-к-подходу-gc-на-андроид-что-же-он-считает-мусором" title="Direct link to heading">​</a></h3><p>Объекты, на которые отсутствуют ссылки, считаются мусором. Также живыми могут считаться только те объекты, до которых мы можем добраться посредством цепочки ссылок, начиная с корневой (Garbage Collector Root) - ссылки, непосредственно существующей в выполняемом коде. Если мы представим все объекты и ссылки между ними как дерево, то нам нужно будет пройти с корневых узлов (точек) по всем рёбрам. При этом узлы, до которых мы сможем добраться - не мусор, все остальные - мусор. Этот подход получил название “трассировка” (tracing). Существует несколько типов корневых точек:</p><ul><li>локальные переменные и параметры методов;</li><li>активные потоки;</li><li>статические переменные (так как на них ссылаются их классы)</li></ul><p>Именно поэтому в андроид не возникает проблемы с утечкой памяти при возникновении циклических зависимостей. Взглянем на иллюстрацию, которая уже была приведена ранее:
<img loading="lazy" alt="Иллюстрация" src="/assets/images/gc-f1ce86f0b4235f1b4cec861f0007b7b1.jpg" width="600" height="280" class="img_E7b_"></p><p>Несколько объектов, изображенных на ней, больше не используются, но каждый из них ссылается на другой. Однако они недостижимы с помощью цепочки сильных ссылок, начинающейся от корневой ссылки сборщика мусора. Поэтому для него такие объекты будут считаться мусором и будут благополучно собраны.</p><p><a href="https://proandroiddev.com/collecting-the-garbage-a-brief-history-of-gc-over-android-versions-f7f5583e433c" target="_blank" rel="noopener noreferrer">Подробнее про сборщики мусора на андроид</a></p><p>Однако утечка памяти на андроид может произойти в том случае, если мы сохраним ссылку на объект с коротким жизненным циклом в объекте с длинным жизненным циклом. Возникнет ситуация, когда первый объект больше не используется, но сборщик мусора не может удалить его из памяти, потому что на него ссылаются другие объекты.</p><p><a href="https://proandroiddev.com/everything-you-need-to-know-about-memory-leaks-in-android-d7a59faaf46a" target="_blank" rel="noopener noreferrer">Подробная статья с примерами</a></p><p>Еще пример утечки памяти: приложение для социальной сети отображает фамилию, имя и рейтинг текущего пользователя на каждом экране приложения. Объект с профилем текущего пользователя существует с момента входа в аккаунт до момента выхода из него, и все экраны приложения обращаются за информацией к одному и тому же объекту. Этот объект также периодически обновляет данные с сервера, так как рейтинг может часто меняться. Необходимо, чтобы объект с профилем уведомлял текущее activity об обновлении рейтинга:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">override fun onResume() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    super.onResume()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    currentUser.addOnUserUpdateListener(this)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Как добиться в этой ситуации утечки памяти? Забыть отписаться от уведомлений в методе onPause:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">override fun onPause() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    super.onPause()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /* Забудьте про следующую строчку и вы получите серьёзную утечку памяти */</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    currentUser.removeOnUserUpdateListener(this)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Activity будет продолжать обновлять интерфейс каждый раз, когда профиль будет обновляться. Даже после того, как экран перестанет быть видим пользователю. Это может привести к видимому торможению интерфейса в момент обновления профиля — и не только на этом экране.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="слабые-ссылки">Слабые ссылки<a class="hash-link" href="#слабые-ссылки" title="Direct link to heading">​</a></h2><p>Для решения этой проблемы существуют слабые ссылки. Мы можем сохранять не только сильные ссылки на объекты, но и слабые. Объект, на который существуют только слабые ссылки, может быть удален в любой момент при вызове cборщика мусора, для этого не обязательно условие нехватки памяти. А ссылка перестанет ссылаться на объект и примет значение null.</p><p>В ARC существует точно такой же механизм создания слабых ссылок на объект. При присвоении объекту слабой ссылки счетчик сильных ссылок на него не увеличивается. Этот экземпляр может быть удален ARC из памяти, пока слабая ссылка все еще ссылается на него. После чего ARC автоматически присвоит слабой ссылке nil, когда экземпляр, на который она указывает, освобождается.</p><p>Если двум объектам нужно иметь ссылку друг на друга, объекту А (имеющему меньшую продолжительность жизни) следует иметь слабую ссылку на объект Б, который имеет большую продолжительность жизни, тогда как Б может иметь сильную ссылку на объект А.</p><p><strong>Пример использования слабых ссылок на андроид:</strong>
Есть приложение, которое позволяет пользователю загружать из сети изображения в высоком разрешении и просматривать их. Медиафайлы хранятся на сервере, откуда их можно получить с помощью GET-запроса. Пользователь нетерпелив, он не намерен ждать при каждом запуске приложения, пока загрузятся все файлы. Поэтому возникает идея сохранить файлы в памяти приложения в виде какой-либо структуры данных (список, мапа), чтобы потом без задержки показывать изображения пользователю. Структура данных будет создаваться как обычно, с помощью сильной ссылки. Перед загрузкой каждого медиафайла будет происходить проверка, находится ли это изображение в памяти, и если нет, то оно будет загружаться в список. Однако файлы декодированных изображений в формате Bitmap будут занимать много места, и если продолжить скачивание без возможности очистки этого списка, то приложение упадет с ошибкой нехватки памяти. Как быть? Создавать структуру данных с помощью слабой ссылки!</p><blockquote><p>[!IMPORTANT]<!-- -->
Приведенный пример правдив для android-системы со сборщиком мусора, но неверен для ios - ARC не ждёт возникновения ситуации, в которой нужно чистить память, он удаляет объект сразу, как только на него не осталось сильных ссылок. На ios данный кеш в оперативке никогда не будет работать - сразу после создания объекта и помещения в этот кеш объект будет удаляться из-за отсутствия сильных ссылок.</p></blockquote><p><a href="https://kmm.icerock.dev/learning/libraries/moko/moko-units#%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE-%D0%BB%D0%B8-%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D0%B2%D0%B0%D1%82%D1%8C-%D0%BB%D1%8F%D0%BC%D0%B1%D0%B4%D1%83-%D0%B2-unititem" target="_blank" rel="noopener noreferrer">Реальный кейс использования слабых ссылок в общем коде</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="управление-памятью-в-kotlin-native">Управление памятью в Kotlin Native<a class="hash-link" href="#управление-памятью-в-kotlin-native" title="Direct link to heading">​</a></h2><p>Осуществляется комбинированно с помощью автоматического подсчета ссылок на объекты (аналогично подходу ARC, работает в режиме реального времени) + с помощью сборщика мусора для циклических ссылок, основанный на алгоритме пробного удаления. Каждый запуск такого сборщика создаёт микропаузы в работе кода, поэтому частота его запуска строго определена.</p><p>Сборщик мусора в K/N на каждом потоке свой, поэтому можно создавать кучу объектов на фоновом потоке, они будут удаляться из памяти сравнительно долго, но не будут влиять на работу главного потока.</p><p>Для Kotlin / Native был разработан набор ограничений, направленный на возможность обмена данными между потоками. Граф объекта должен быть сначала заморожен, чтобы предотвратить его изменение. Только после этого он может быть передан другим потокам.
<a href="https://blog.jetbrains.com/kotlin/2021/05/kotlin-native-memory-management-update/" target="_blank" rel="noopener noreferrer">Подробнее в источнике</a></p><p><a href="https://habr.com/ru/post/578716/" target="_blank" rel="noopener noreferrer">Работа с новой моделью памяти в Kotlin Native</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="проверь-себя">Проверь себя<a class="hash-link" href="#проверь-себя" title="Direct link to heading">​</a></h4><ol><li>Назовите механизмы работы с памятью в android и в ios.</li><li>Почему важно управлять памятью?</li><li>Какие объекты считаются мусором на android?</li><li>Какие объекты считаются мусором на ios?</li><li>Кратко опишите, как работает Garbage Collector.</li><li>Кратко опишите, как работает ARC.</li><li>В чем заключается различие подхода к управлению памятью на android и ios?</li><li>Какой подход к управлению памятью используется в Kotlin Native?</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/icerockdev/kmm.icerock.dev/tree/docusaurus/learning/memory_management.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/learning/problem-solving/kotlin-native-release-build-failed"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ошибка Release сборки Kotlin/Native</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/learning/concurrency"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Многопоточность</div></a></nav><br></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#однако-что-считается-мусором" class="table-of-contents__link toc-highlight">Однако что считается “мусором”?</a></li><li><a href="#механизм-автоматического-подсчета-ссылок" class="table-of-contents__link toc-highlight">Механизм автоматического подсчета ссылок</a></li><li><a href="#подход-garbage-collector-на-андроид" class="table-of-contents__link toc-highlight">Подход Garbage Collector на андроид</a><ul><li><a href="#вернемся-к-подходу-gc-на-андроид-что-же-он-считает-мусором" class="table-of-contents__link toc-highlight">Вернемся к подходу GC на андроид, что же он считает “мусором”?</a></li></ul></li><li><a href="#слабые-ссылки" class="table-of-contents__link toc-highlight">Слабые ссылки</a></li><li><a href="#управление-памятью-в-kotlin-native" class="table-of-contents__link toc-highlight">Управление памятью в Kotlin Native</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">IceRock Development</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Site</a></li><li class="footer__item"><a href="https://github.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://www.facebook.com/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook</a></li><li class="footer__item"><a href="https://vk.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">VK</a></li><li class="footer__item"><a href="https://www.instagram.com/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UC-Vhmm09W_IWKHhSg80d68w" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li><li class="footer__item"><a href="https://twitter.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter @icerockdev<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/kotlinmpp" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram @kotlinmpp<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/kotlinmppchats" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram @kotlinmppchats<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://kotlinlang.org/lp/mobile" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Mobile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://libs.kmp.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Libs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://codelabs.kmp.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Codelabs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://moko.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">MOKO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/docs/reference/native-overview.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin/Native Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/docs/reference/multiplatform.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 IceRock Development. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b7be8930.js"></script>
<script src="/assets/js/main.46935d83.js"></script>
</body>
</html>