<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-learning docs-doc-id-android/profiling">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-91G2XYQTXS"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-91G2XYQTXS",{})</script><title data-rh="true">Профилирование Jetpack Compose | Kotlin Multiplatform Mobile</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kmm.icerock.dev/learning/android/profiling"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-learning-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-learning-current"><meta data-rh="true" property="og:title" content="Профилирование Jetpack Compose | Kotlin Multiplatform Mobile"><meta data-rh="true" name="description" content="Оптимизируй или сдохни"><meta data-rh="true" property="og:description" content="Оптимизируй или сдохни"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kmm.icerock.dev/learning/android/profiling"><link data-rh="true" rel="alternate" href="https://kmm.icerock.dev/learning/android/profiling" hreflang="en"><link data-rh="true" rel="alternate" href="https://kmm.icerock.dev/learning/android/profiling" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.893f3d2c.css">
<link rel="preload" href="/assets/js/runtime~main.7e89d3fd.js" as="script">
<link rel="preload" href="/assets/js/main.df54c0e6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Home</b></a><a class="navbar__item navbar__link" href="/onboarding/intro">Onboarding</a><a class="navbar__item navbar__link navbar__link--active" href="/learning/intro">Knowledge Base</a><a class="navbar__item navbar__link" href="/university/intro">University</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/icerockdev/kmm.icerock.dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/intro">О разделе</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/code-style/general-rules">CodeStyle</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/gradle/intro-gradle">Gradle</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/learning/android/study-materials">Android</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/study-materials">Материалы для обучения</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/adapter">Adapter and listeners</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/dagger">Dagger</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/data-sharing">Передача данных при навигации</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/layout">Верстка</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/learning/android/libraries/yandexmap">Библиотеки</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/navigation">Навигация</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/learning/android/profiling">Профилирование Jetpack Compose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/sdk-migrations">Android SDK migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/service">Сервисы</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learning/android/tips">Tips</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/ios/study-materials">iOS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin/study-materials">Kotlin</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/compose-multiplatform/links">Compose Multiplatform</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin-multiplatform/how-to-start">Kotlin Multiplatform</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/kotlin-native/summary">Kotlin/Native</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/libraries/kotlinx/coroutines">Библиотеки</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/learning/problem-solving/gradle-daemon-crash">Решения проблем</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/memory_management">Работа с памятью</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/concurrency">Многопоточность</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/state">Единый стейт экрана</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/socket">Socket</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/links">Ссылки</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/code">Примеры кода</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learning/movement_workspace_dir">Перенос dev tools на другой диск</a></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Android</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Профилирование Jetpack Compose</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_bZGK theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_l22C">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Профилирование Jetpack Compose</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="оптимизируй-или-сдохни">Оптимизируй или сдохни<a class="hash-link" href="#оптимизируй-или-сдохни" title="Direct link to heading">​</a></h2><p>Когда в гуглплее посыпятся жалобы на зависания и заторможенность вашего новенького, свеженького
приложения на композе(а они возникнут), вам пригодятся советы по оптимизации и профилированию,
описанные в данной статье.</p><p>Разберем эти советы на примере приложения Кампус - приложения для просмотра расписания занятий.
Основная фича это экран расписания, состоящий из
двух <a href="https://google.github.io/accompanist/pager/" target="_blank" rel="noopener noreferrer">Pager&#x27;ов</a> для недели и дня, свайпы по которым
вызывали зависания у пользователей.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="recomposition-counts">Recomposition Counts<a class="hash-link" href="#recomposition-counts" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="рекомпозиции">Рекомпозиции<a class="hash-link" href="#рекомпозиции" title="Direct link to heading">​</a></h3><p>Первое, на что нужно обратить внимание -
понятие <a href="https://developer.android.com/jetpack/compose/mental-model#recomposition" target="_blank" rel="noopener noreferrer">рекомпозиции</a>.</p><p>Рендер экрана в Compose состоит из прохода по
графу <a href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/Composable" target="_blank" rel="noopener noreferrer">composable</a>
функций. Если состояние вершины графа меняется - меняются аргументы composable метода, значения
MutableState или анимации, то вызывается перестроение подграфа, т.е. повторный вызов функций, это
перестроение называется <strong>рекомпозицией</strong>. Перестроения выполняются быстро, и не должны вызывать
проблем, но частые рекомпозиции могут вызывать подтормаживания.</p><p>Это одновременно и главная особенность композа, и его подводный камень. Ведь разработчик может
доспустить ошибки, которые могут привести к излишним рекомпозициям, например пересоздавать объект
вместо переиспользования. Это приведет к излишним вычислениям и проблемам с производительностью.</p><p>На больших проектах эти ошибки можно не заметить невооруженным глазом, поэтому Android Studio
предлагает вооружить наш глаз
тулзой <a href="https://developer.android.com/jetpack/compose/performance#recomposition-counts" target="_blank" rel="noopener noreferrer">Recomposition Counts</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="применение">Применение<a class="hash-link" href="#применение" title="Direct link to heading">​</a></h3><p>Вы можете использовать Layout Inspector для проверки, как часто composable функция вызывается заново
или пропускается.
Следуйте <a href="https://developer.android.com/jetpack/compose/tooling#recomposition-counts" target="_blank" rel="noopener noreferrer">инструкции</a>,
чтобы открыть необходимую статистику.</p><p>После добавления recomposition counts в инспекторе у нас появятся два столбца, отвечающие за число
рекомпозиций и пропусков каждого composable метода.</p><p>На примере Кампуса проверим, есть ли у нас излишние рекомпозиции, запустим проект на симуляторе и
перейдем в Layout Inspector:
Заметили, что при cвайпе на следующий день метод <code>ScheduleDayPage</code> и <code>RemoteStateContent</code>
рекомпозируются по 3 раза и не пропускаются вовсе(по логике он должен рекомпозироваться один раз)</p><p><img loading="lazy" alt="img.png" src="/assets/images/recomposition_counts_1-a1ad34299a93eb2e89300632a631a1c1.png" width="1618" height="870" class="img_E7b_">
<img loading="lazy" alt="img_1.png" src="/assets/images/recomposition_counts_2-7c75fe945528b36c7b836751cac6edae.png" width="1622" height="870" class="img_E7b_"></p><p>Таким образом нам удалось локализовать проблему, мы зафиксировали метод, которому следует уделить
пристальное внимание:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fun ScheduleDayPage(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    state: RemoteState&lt;ScheduleDay&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onItemClick: (ScheduleDetails) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    viewAds: (ScheduleDay.Lesson) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    clickOnAds: (ScheduleDay.Lesson) -&gt; Unit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="composable-metrics">Composable metrics<a class="hash-link" href="#composable-metrics" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="стабильные-типы">Стабильные типы<a class="hash-link" href="#стабильные-типы" title="Direct link to heading">​</a></h3><p>Чтобы понять почему метод рекомпозируется несколько раз нужно познакомиться с
понятием <a href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/Stable" target="_blank" rel="noopener noreferrer">стабильности</a>
.</p><p>Стабильность это гарантия компилятору что тип не будет изменяться, либо уведомит о своем изменении.
Компилятор не будет запускать проверку на изменение состояния composable метода, если все его
агрументы будут стабильными.</p><p>Следовательно <strong>Стабильными типами</strong> данных называют типы, инстансы которых неизменяемы, либо
уведомляют композицию об изменении своего состояния.
Помимо стабильных и нестабильных типов выделяют третий тип: иммутабельный. Это более строгий класс,
который гарантирует, что обьект не будет изменен вообще.</p><p>Более строгое определение стабильного типа выглядит так:</p><p><strong>Стабильный тип</strong> должен соответствовать следующим требованиям:</p><ol><li>Результат вызова equals для двух инстансов будет всегда одинаков;</li><li>Если публичное поле класса изменяется, то композиция об этом узнает;</li><li>Все публичные поля имеют стабильный тип.</li></ol><p>Чтобы третье условие соблюдалось, требуется наличие стабильных типов, которые разработчики могут
использовать для создания собственных типов данных. Jetpack Compose Compiler считает стабильными
следующие типы:
Примитивные типы,
String,
Функциональные типы,
Перечисления.</p><p>В <a href="https://medium.com/@denisgolubev1999/jetpack-compose-%D0%BF%D0%BE%D0%B4-%D0%BA%D0%B0%D0%BF%D0%BE%D1%82%D0%BE%D0%BC-%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%BF%D0%BE%D0%B7%D0%B8%D1%86%D0%B8%D1%8F-%D0%B8-%D1%81%D1%82%D0%B0%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D0%B8%D0%BF%D1%8B-9598f8b62006" target="_blank" rel="noopener noreferrer">статье</a>
, которую я рекомендую для более глубокого понимания определений рекомпозиции и стабильных типов,
приведен следующий пример:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Все поля класса неизменяемы. StableClass1 стабильный</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class StableClass1(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    val immutableValue: Int</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Композиция узнает об изменении состояния благодаря MutableState. StableClass2 стабильный</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class StableClass2(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    val mutableState: MutableState&lt;String&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Имеются изменяемые поля. UnstableClass1 нестабильный</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class UnstableClass1(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    var immutableValue: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Тип поля unstableTypeField нестабильный. UnstableClass2 нестабильный</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class UnstableClass2(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    val unstableTypeField: UnstableClass1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Так же разработчики могут помечать классы аннотациями <code>@Stable</code> и <code>@Immuatable</code>.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="применение-1">Применение<a class="hash-link" href="#применение-1" title="Direct link to heading">​</a></h3><p>Для выявления стабильных и нестабильных типов, а так же пропускаемых и перезапускаемых методов,
которые мы обнаружили с помощью <strong>recomposition counts</strong>, можно воспользоваться
тулзой <a href="https://chris.banes.dev/composable-metrics/" target="_blank" rel="noopener noreferrer">composable metrics</a>.</p><p>Для получения статистики по проекту нужно добавить таску в <code>app/build.gradle.kts</code> и запустить
релизную сборку с активным флажком, согласно статье.</p><p><img loading="lazy" alt="img.png" src="/assets/images/composable_metricks-fdb78b6d95ed9c047e62cff1fad2d744.png" width="684" height="309" class="img_E7b_"></p><p>В результате в папке <code>build/compose_metrics</code> мы обнаружим 4 файла, которые содержат соответственно:</p><ul><li>app_release-classes.txt - информацию по стабильности классов</li></ul><div class="language-text codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">unstable class MigrationScreen {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  unstable val navController: NavController</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;runtime stability&gt; = Unstable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stable class ExpandedStateStrings {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable val expandString: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable val collapseString: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;runtime stability&gt; = Stable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>app_release-composables.txt - информацию рекомпозируемый метод или пропускаемый</li></ul><div class="language-text codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">restartable skippable scheme(&quot;[androidx.compose.ui.UiComposable]&quot;) fun TopAppBarTitle(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable modifier: Modifier? = @static Companion</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable name: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable date: String</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable weekName: String?</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  stable menuExpanded: MutableState&lt;Boolean&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>app_release-composables.csv - тот же файл только в виде таблицы</li><li>app_release-module.json - общую информацию по проекту</li></ul><div class="language-text codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;skippableComposables&quot;: 693,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;restartableComposables&quot;: 838,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;readonlyComposables&quot;: 0,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;totalComposables&quot;: 882,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Вернемся к Кампусу, нам был интересен метод <code>ScheduleDayPage</code>, для поиска информации по нему
перейдем в файл <code>app_release-composables.txt</code></p><div class="language-text codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">restartable scheme(&quot;[androidx.compose.ui.UiComposable]&quot;) fun ScheduleDayPage(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">unstable state: RemoteState&lt;ScheduleDay&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stable onItemClick: Function1&lt;ScheduleDetails, Unit&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stable viewAds: Function1&lt;Lesson, Unit&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stable clickOnAds: Function1&lt;Lesson, Unit&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Как мы уже поняли, этот метод не является <code>skippable</code> и будет рекомпозироваться при любом удобном
случае. Так же можем видеть, что аргумент <code>state</code> является нестабильным.</p><p>Для того чтобы поправить это, можем добавить аннотацию <code>@Immutable</code> классам <code>RemoteState</code>
и <code>ScheduleDay</code>, убедившись, что данные классы не будут меняться после создания.</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Не следует вешать эту аннотацию классам с var полями или содержащим списки</p></div></div><p>Это решило проблему нестабильного класса, но с этим методом еще не все окончено. Он уже помечен в
метрике, как <code>skippable</code>, однако в инспекторе мы все еще замечаем ненужные рекомпозиции.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="нестабильные-списки">Нестабильные списки<a class="hash-link" href="#нестабильные-списки" title="Direct link to heading">​</a></h3><p>Есть способ переопределить стабильность классов с помощью аннотаций, но это не решит проблему
стабильности списков, сетов и словарей.</p><p>В
данной <a href="https://christopherward.medium.com/debugging-and-fixing-a-huge-jetpack-compose-performance-problem-in-my-sudoku-solver-app-8f67fa229dc2" target="_blank" rel="noopener noreferrer">статье</a>
предлагается решение данной проблемы с помощью
библиотеки <a href="https://github.com/Kotlin/kotlinx.collections.immutable" target="_blank" rel="noopener noreferrer">kotlinx-collections-immutable</a>,
которая позволяет явно указать, что <code>Composable</code> метод должен принимать неизменяемый список.</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fun StableGrid(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    values: ImmutableList&lt;GridItem&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="нестабильные-лямбды">Нестабильные лямбды<a class="hash-link" href="#нестабильные-лямбды" title="Direct link to heading">​</a></h3><p>У нашего класса <code>ScheduleDayPage</code> в качестве аргументов также идут функции, с которыми нужно быть
осторожным в композе. Перейдем к месту инициализации метода:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">internal fun ScheduleScreenContent(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selectedDate: LocalDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onDateSelected: (LocalDate) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onItemClick: (ScheduleDetails) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    viewAds: (LocalDate, ScheduleDay.Lesson) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    clickOnAds: (LocalDate, ScheduleDay.Lesson) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    scheduleDayForDate: (LocalDate) -&gt; StateFlow&lt;RemoteState&lt;ScheduleDay&gt;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CalendarDayPager(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        selectedDate = selectedDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        onDateSelected = onDateSelected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        dayContent = { date -&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val scheduleDayFlow: StateFlow&lt;RemoteState&lt;ScheduleDay&gt;&gt; = remember(date) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                scheduleDayForDate(date)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val scheduleDay: RemoteState&lt;ScheduleDay&gt; by scheduleDayFlow.collectAsState()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ScheduleDayPage(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                state = scheduleDay,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                onItemClick = onItemClick,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                viewAds = { lesson -&gt; viewAds(date, lesson) },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                clickOnAds = { lesson -&gt; clickOnAds(date, lesson) }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Следует обратить внимание на то, как предаются функции в наш метод <code>ScheduleDayPage</code>.</p><p>В Compose есть такое понятие, как <strong>нестабильные лямбды</strong>, которое было хорошо описано
в <a href="https://multithreaded.stitchfix.com/blog/2022/08/05/jetpack-compose-recomposition/" target="_blank" rel="noopener noreferrer">данной статье</a></p><p>В статье следует обратить внимание на то, как компилятор обрабатывает лямбды, а именно создает
анонимный класс с методом <code>invoke()</code>, в котором находится содержимое лямбды. Иными словами, каждый
раз при передаче лямбды мы создаем объект анонимного класса, который при этом не имеет хэша, по
которому компилятор сравнил бы его на шаге перестройки. Следовательно компилятор посчитает, что
состояние узла графа поменялось и нужно провести рекомпозицию.</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Следовательно <strong>composable metrics</strong> не отметит лямбды, как <code>Unstable</code>, но рекомпозиция проведена
будет.</p></div></div><p>Кроме того у лямбды помимо передаваемых аргументов, есть аргументы извне, такие как контекст, из-за
которых нагенерированные компилятором классы будут отличаться.</p><p>В той же статье приводится 4 решения данной проблемы:</p><p><strong>1. Ссылки на методы</strong></p><p>Использовать ссылки на методы вместо лямбды, так мы предотвратим создание нового класса. Ссылки на
методы являются <code>Stable</code> функциональными типами и будут оставаться эквивалентными между
композициями.</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Вместо лямбды</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{ lesson -&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    viewModel.playHooky(lesson)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// использовать ссылку на метод</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">viewmodel::playHooky</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2. Использование remember</strong></p><p>Другой вариант - запоминать экземпляр лямбды между композициями. Это гарантирует, что точно такой же
экземпляр лямбды будет повторно использоваться при дальнейших композициях.</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Создать запоминаемый объект и передавать при инициализации его</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val playHookyRemember: (Lesson) -&gt; Unit = remember { { viewModel.playHooky(it) } }</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Документация
Android <a href="https://developer.android.com/jetpack/compose/performance#use-remember" target="_blank" rel="noopener noreferrer">советует</a> не
забывать про remember</p></div></div><p><strong>3. Статичные функции</strong></p><p>Если лямбда-выражение просто вызывает функцию верхнего уровня, то компилятор посчитает лямбду
стабильной, тк функции верхнего уровня не получают аргументы извне, такие как контекст.</p><p><strong>4. Использование @Stable в лямбде</strong></p><p>Пока выражение в лямбде затрагивает только другие стабильные типы, оно не будет перестраиваться
компилятором при рекомпозиции графа.</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">var skippedLessons by remember { mutableStateOf(listOf(&quot;Biology&quot;, &quot;Geography&quot;, &quot;Chemistry&quot;)) }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Schedule(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    playHooky = { lesson -&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        skippedLessons += lesson</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Вернувшись к Кампусу, используя полученные знания, можем исправить неправильные передачи лямбды
следующим образом:</p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">internal fun ScheduleScreenContent(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selectedDate: ComposeDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onDateSelected: (LocalDate) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onItemClick: (ScheduleDetails) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    viewAds: (LocalDate, ScheduleDay.Lesson) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    clickOnAds: (LocalDate, ScheduleDay.Lesson) -&gt; Unit,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    scheduleDayForDate: (LocalDate) -&gt; StateFlow&lt;RemoteState&lt;ScheduleDay&gt;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CalendarDayPager(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        selectedDate = selectedDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        onDateSelected = onDateSelected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        dayContent = { date -&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val scheduleDayFlow: StateFlow&lt;RemoteState&lt;ScheduleDay&gt;&gt; = remember(date) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                scheduleDayForDate(date.toLocalDate())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val scheduleDay: RemoteState&lt;ScheduleDay&gt; by scheduleDayFlow.collectAsState()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Вынесли лямбду в отдельный объект используя remember </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val viewAdsRemember: (ScheduleDay.Lesson) -&gt; Unit =</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                remember(date) { { lesson -&gt; viewAds(date.toLocalDate(), lesson) } }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Вынесли лямбду в отдельный объект используя remember </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val clickOnAdsRemember: (ScheduleDay.Lesson) -&gt; Unit =</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                remember(date) { { lesson -&gt; clickOnAds(date.toLocalDate(), lesson) } }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ScheduleDayPage(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                state = scheduleDay,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                onItemClick = onItemClick,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                viewAds = viewAdsRemember,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                clickOnAds = clickOnAdsRemember</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="cpu-profiling">CPU Profiling<a class="hash-link" href="#cpu-profiling" title="Direct link to heading">​</a></h2><p>Самым весомым оружием в борьбе с зависаними
является <a href="https://developer.android.com/studio/profile/cpu-profiler" target="_blank" rel="noopener noreferrer">профилирование CPU</a>, а
оптимизация использования процессора вашего приложения имеет много преимуществ, таких как
обеспечение более быстрого и плавного взаимодействия с пользователем и сохранение времени автономной
работы устройства.</p><p>Вы можете использовать профилировщик ЦП для проверки использования ЦП вашего приложения и активности
потоков в режиме реального времени во время взаимодействия с вашим приложением.</p><p>Как запустить профилирование хорошо описано
в <a href="https://medium.com/androiddevelopers/spot-your-ui-jank-using-cpu-profiler-in-android-studio-9a4c41a54dab" target="_blank" rel="noopener noreferrer">статье</a>
, разберем какие возможности дает нам эта статистика на примере Кампуса.</p><p>Запустим проект на симуляторе и перейдем во вкладку <code>Profiler</code>.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_1-8c56167df99638868e3134f6f04e8933.png" width="911" height="150" class="img_E7b_"></p><p>После запуска приложения появится графики <code>CPU</code>, <code>MEMORY</code>, <code>ENERGY</code>. Нас интересует статистика
для <code>CPU</code>, в детальном виде статистики вы должны увидеть следующее:</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_2-c8e7f2475553df5c83375ad983edfa56.png" width="1879" height="637" class="img_E7b_"></p><p>Чтобы создать запись статистики щелкните <code>Record</code>, позаимодействуйте с приложением и
нажмите <code>Stop</code>.</p><p>После создания записи вы должны увидеть следующее окно с графиком загрузки процессора на записанном
интервале <code>CPU Usage</code> (1), статистикой по взаимодействиям с приложением <code>Interaction</code> (2),
потоками <code>Threads</code> (3) и детальной
статистикой по потоку <code>Analysis</code> (4).</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_3-75f583cea732fb20c84c89f7553754b8.png" width="1876" height="717" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="flame-chart">Flame Chart<a class="hash-link" href="#flame-chart" title="Direct link to heading">​</a></h3><p>Нас дальше будет интересовать вкладка <strong>Flame Chart</strong>, в которой находится график, представляющий
собой граф вызовов функций с занимаемым ими временем работы процессора. С помощью него
удобно находить выделяющиеся по времени процессы, которые можно оптимизировать.</p><p>Для начала выберем интересующий нас интервал в окне <code>CPU Usage</code>.</p><p>Далее его можно зафиксировать более детально в окне <code>Threads</code>. Выберем наиболее явно выраженные
столбцы.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_4-ee08db66b97e2ebafea77c83aba537e5.png" width="1679" height="954" class="img_E7b_"></p><p><strong>На что обращать внимание:</strong></p><ol><li>16.67 миллисекунд</li></ol><p>Стандартная частота обновления для большинства дисплеев смартфонов
составляет 60 Гц. Частота обновления 60 Гц означает, что дисплей обновляется 60 раз в секунду.
Другими словами, изображение на дисплее обновляется полностью каждые 16.67 миллисекунды (мс).</p><p>Чтобы достичь плавного UI, нужно стремиться к отрисовки компонент в 16.67 ms. Flame Chart содержит
время процессора занимаемое компонентами, старайтесь сделать его как можно меньше. Обращайте
внимание на наиболее &quot;тяжелые&quot; методы.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Показатель времени отрисовки следует считать в соотношении - данные в Flame Chart к количесву секунд
в выбранном интервале. Точное время интервала показывается во вкладке <code>Summary</code>.</p></div></div><ol start="2"><li>Дайте процессору отдохнуть</li></ol><p>Старайтесь сделать так, чтобы большую часть времени процессор находился в ожидании.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_9-0ef76224f589fc627f8f661efb2703df.png" width="824" height="392" class="img_E7b_"></p><ol start="3"><li>Компоненты, на которые мы можем повлиять</li></ol><p>Можем выбрать в поиске методы, на которые мы можем повлиять, к примеру произведем поиск по имени
нашего проекта, «пламя» с нашими метода выделятся цветом, а в полосах с методами текст выделится
жирным.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_5-5f482c77d4a75f680610350f4f70c208.png" width="834" height="396" class="img_E7b_"></p><ol start="4"><li>Методы, которые мы можем перенести на другой поток</li></ol><p>Некоторые &quot;тяжелые&quot; задачи можно перенести на другой поток. К примеру работу с базами данных.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_10-6c5c7ffcdb2d0b0bd937633398a4fbd6.png" width="709" height="300" class="img_E7b_"></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Более подробную информацию по возможностям профилировщика ЦП можно найти
в <a href="https://russianblogs.com/article/9627812896/" target="_blank" rel="noopener noreferrer">статье</a></p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="применение-2">Применение<a class="hash-link" href="#применение-2" title="Direct link to heading">​</a></h3><p>Вернемся к Кампусу, в нашем случае записаны свайпы по экрану расписания
Кампуса, которые хотелось бы оптимизировать. Выберем один из них в окне <code>CPU Usage</code> и выберем
главный поток в окне <code>Threads</code>. В поиске выберем наш проект, сразу видны 3 метода,
на который тратится много времени.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_6-7f069a33abfb78caadeff1e79acff548.png" width="1680" height="880" class="img_E7b_"></p><p>Разберем один из них. На метод <code>WeekPage</code> тратится аж 400 ms на отрезке в 4 секунды. Для получения
более точного значения следует выбрать усреднение по нескольким значениям. Запомним примерное
значение времени процессора на данный метод ~ 95 ms.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_7-f161e612242d87bafdb6af1e352fe503.png" width="664" height="276" class="img_E7b_"></p><div class="language-kotlin codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-kotlin codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@Composable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fun WeekPage(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    startOfWeek: LocalDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    selectedDate: LocalDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    currentDate: LocalDate,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    onDateSelected: (LocalDate) -&gt; Unit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Row(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        modifier = Modifier</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .fillMaxWidth()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            .padding(horizontal = 16.dp),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        horizontalArrangement = Arrangement.SpaceBetween</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        DayOfWeek.values().forEach { dayOfWeek -&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val date: LocalDate = startOfWeek.plus(DatePeriod(days = dayOfWeek.ordinal))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val simpleDateFormat = SimpleDateFormat(&quot;EE&quot;, Locale.getDefault())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val dayOfWeekName = simpleDateFormat.format(date.toJavaDate()).uppercase()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            val shape = RoundedCornerShape(8.dp)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Box(...) { ... }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Обратившись к коду можем заметить явный косяк, <code>SimpleDayFormatter</code> инициализируется в цикле для
каждого элемента Row. Можем поправить это, вынеся инициализацию из Row и использовав <code>remember</code>.</p><p>После исправления проверим результат. Такими действиями нам удалось сократить время на
отрисовку <code>WeekPage</code> до
60-70ms. (На изображении выбран интервал ~ 1s)</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_8-0c41d227314f7dfbe854a94deab6d782.png" width="836" height="408" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="оптимизация-compose">Оптимизация Compose<a class="hash-link" href="#оптимизация-compose" title="Direct link to heading">​</a></h3><p>По теме оптимизации Jetpack Compose рекомендую
обратиться <a href="https://developer.android.com/jetpack/compose/performance#best-practices" target="_blank" rel="noopener noreferrer">официальной документации</a>
и к <a href="https://proandroiddev.com/7-things-to-keep-in-mind-while-building-jetpack-composables-7e4a5ecaa8b0" target="_blank" rel="noopener noreferrer">статье
на Medium</a>
.</p><p>Наиболее полезные советы:</p><p><strong>1. Всегда используйте remember в своих composable методах.</strong></p><p>Декомпозиция может сработать в любое время по целому ряду причин. Если у нас есть значение, которое
должно было пережить перекомпозицию, то remember поможет вам сохранить его при перекомпозиции.</p><p><strong>2. Используйте Lazy лэйауты только по необходимости</strong></p><p>LazyRow для списка из 5 элементов может существенно затормозить рендер.</p><p><strong>3. Откажитесь по возможности от ConstraintLayout</strong></p><p>Используйте вместо него Column и Row. ConstraintLayout представляет собой систему линейных
уравнений, что требует больше вычислений нежели построение элементов один за другим.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="system-trace">System Trace<a class="hash-link" href="#system-trace" title="Direct link to heading">​</a></h3><p>Кроме того вы можете получить статистику по загруженнности CPU, сконцентрированную только на
composable методах. Для этого вам нужно воспользоваться
тулзой <a href="https://medium.com/androiddevelopers/jetpack-compose-composition-tracing-9ec2b3aea535" target="_blank" rel="noopener noreferrer">Jetpack Compose Composition Tracing</a>
.</p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Тулза доступна только при следующих версиях технологий и выше</p><ol><li>Android Studio Flamingo Canary 1</li><li>Compose UI: 1.3.0-beta01</li><li>Compose Compiler: 1.3.0</li></ol></div></div><p>Compose Composition Tracing позволяет
отображать composable функции Jetpack Compose в профилировщике <strong>System Trace</strong> Android Studio
Flamingo. Следуйте инструкции в статье по ссылке, вам необходимо установить подходящую версию
Android Studio и добавить зависимость в <code>app/gradle.kts</code>.</p><p>В <code>CPU Profiler</code> выберите конфигурацию <code>System Trace</code>, щелкните <code>Record</code>, позаимодействуйте с
приложением и
нажмите <code>Stop</code>.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_1-5e9959106a8dc8d70d65c27d5f4e8be3.png" width="823" height="295" class="img_E7b_"></p><p>После создания записи вы должны увидеть следующее окно:</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_2-0d0b8c50ae752cc134144c685230750a.png" width="1679" height="812" class="img_E7b_"></p><p>При проверке системной трассировки вы можете просмотреть события трассировки на временной шкале
потоков, чтобы просмотреть подробную информацию о событиях, происходящих в каждом потоке.</p><p>У нас появилось несколько новых
вкладок: <code>Display</code> (1), <code>Frame Lifecycle</code> (2), <code>CPU Cores</code> (3), <code>Process Memory</code> (4), а
вкладка с потоками немного изменилась, на ней появился граф composable функций.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_3-dbf62c19d013db58e3064eaa959ce32c.png" width="1053" height="642" class="img_E7b_"></p><p>В этих вкладках можно найти объем активности на каждом ядре, объем физической памяти, используемой в
настоящее время приложением и другое.</p><p>Во вкладке <code>Threads</code> находится граф, а детальной статистике по потокам так же
находится <code>Flame Chart</code>, в котором будет преведена статистика только по composable методам.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_4-f344b4a1a0df1b88c36da2cf8e982410.png" width="1678" height="518" class="img_E7b_"></p><p>На методы в <code>threads</code> можно нажать, и выполнить поиск этого метода по всему записанному интервалу, что
покажет, как часто этот метод вызывался и сколько времени занял, в среднем и покаждому вызову.</p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_5-e7ebf72e0b9f38686e9eecad01cd7e83.png" width="1054" height="404" class="img_E7b_"></p><p><img loading="lazy" alt="img.png" src="/assets/images/cpu_profiler_trace_6-2a14c164d937acd9ef9a5811f9ae26fd.png" width="1259" height="813" class="img_E7b_"></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Более подробную информацию по возможностям system trace можно найти
в <a href="https://developer.android.com/studio/profile/inspect-traces" target="_blank" rel="noopener noreferrer">официальной документации</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="gpu-profiling">GPU Profiling<a class="hash-link" href="#gpu-profiling" title="Direct link to heading">​</a></h2><p>Немаловажным инструментом профилирования
является <a href="https://developer.android.com/topic/performance/rendering/inspect-gpu-rendering" target="_blank" rel="noopener noreferrer">GPU профилировщик</a>
.</p><p>Как сказано в документации, инструмент рендеринга Profile GPU отображает в виде гистограммы
прокрутки визуальное представление того, сколько времени требуется для рендеринга кадров окна
пользовательского интерфейса относительно контрольного показателя в 16,67 мс на кадр.</p><p><img loading="lazy" alt="img.png" src="/assets/images/gpu_profiler_1-9d5c22a2cd6f3541d3e34e8ee9b77df0.png" width="650" height="326" class="img_E7b_"></p><p>Для этого вам понадобится андроид девайс с версией Android 4.1 (API level 16) или выше. Инструкция
по подключению описана в документации.</p><p>Горизонтальная зеленая линия соответствует 16,67 миллисекундам. Чтобы достичь 60 кадров в секунду,
вертикальная полоса для каждого кадра должна оставаться ниже этой линии. Каждый раз, когда полоса
превышает эту линию, в анимации могут возникать паузы.</p><p>В <a href="https://developer.android.com/topic/performance/rendering/inspect-gpu-rendering#gpu_rendering_output" target="_blank" rel="noopener noreferrer">документации</a>
указано, за что отвечают столбцы по цветам.</p><p><img loading="lazy" alt="img.png" src="/assets/images/gpu_profiler_2-0020339362f06d36adc336dd0f6801ad.png" width="1280" height="844" class="img_E7b_"></p><p>На примере Кампуса, можно обратить внимание на выраженные столбцы голубого, светло и темно зеленых
цветов.</p><p>Следовательно много времени используется для создания и обновления списков(<strong>голубой цвет</strong>),
возможно много кастомных
вью или много работы методов onDraw. Много временить тратится на обратку методов onLayout
и onMeasure(<strong>светло зеленый</strong>), может быть отрисовывается сложная иерархия вью. Так же много
времени
уходит на аниматоры, которые выполняются для вью, и на обработку входных коллбэки(<strong>темно зеленый</strong>)
, биндинги во время скроллинга,
такие как <code>RecyclerView.Adapter.onBindViewHolder()</code>, обычно происходят в этом сегменте и являются
наиболее распространенным источником замедлений в этом сегменте.</p><p>На следующем изображении показан график для приложения после различных оптимизаций, описанных ранее.</p><p><img loading="lazy" alt="img.png" src="/assets/images/gpu_profiler_3-89072dc0d42570a109ed95cd3f9ab3c9.png" width="1280" height="844" class="img_E7b_"></p><p>Судя по результатам, оптимизировать еще есть куда.</p><p>Также был проведён эксперимент в рамках другого нашего проекта,который был создан по классической схеме SingleActivity с неким множеством фрагментов, которые были представлены в виде xml c компоуз вьюшкой, с аналогичной целью оптимизации jetpack compose в рамках которого было определено следующее: Если в проекте используется связка xml и вьюшки компоуза внутри, в таком случае все вышеописанные действия по профилированию и попытки опитимизации будут пустой тратой времени, так как профилировщик(на данный момент) не способен достучаться до компоуз экрана который лежит в xml файлике. Всё что вы увидете в таком случае, это то что ваш экран работает, но подкопотную магию, работу функций и счётчик рекомпозиций, вам будет недоступен. Но что любопытно, запустив превью вашей компоуз функции, можно получить кол-во рекомпозиций, но это ни на что не повлияет!
Вывод можно сделать такой: Думайте на два шага вперёд и если жаждите работать с Jetpack Compose, не занимайтесь его &quot;селекцией&quot; с xml, а возьмите себя в руки, и пилите всё как положено, и только в таком случае, счётчик рекомпозиций и профилировщик станут вашим другом, и незаменимым помощником  </p><h2 class="anchor anchorWithStickyNavbar_mojV" id="полезные-ссылки">Полезные ссылки<a class="hash-link" href="#полезные-ссылки" title="Direct link to heading">​</a></h2><ul><li><a href="https://multithreaded.stitchfix.com/blog/2022/08/05/jetpack-compose-recomposition/" target="_blank" rel="noopener noreferrer">Gotchas in Jetpack Compose Recomposition</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/icerockdev/kmm.icerock.dev/tree/docusaurus/learning/android/profiling.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/learning/android/navigation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Навигация</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/learning/android/sdk-migrations"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Android SDK migration</div></a></nav><br></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#оптимизируй-или-сдохни" class="table-of-contents__link toc-highlight">Оптимизируй или сдохни</a></li><li><a href="#recomposition-counts" class="table-of-contents__link toc-highlight">Recomposition Counts</a><ul><li><a href="#рекомпозиции" class="table-of-contents__link toc-highlight">Рекомпозиции</a></li><li><a href="#применение" class="table-of-contents__link toc-highlight">Применение</a></li></ul></li><li><a href="#composable-metrics" class="table-of-contents__link toc-highlight">Composable metrics</a><ul><li><a href="#стабильные-типы" class="table-of-contents__link toc-highlight">Стабильные типы</a></li><li><a href="#применение-1" class="table-of-contents__link toc-highlight">Применение</a></li><li><a href="#нестабильные-списки" class="table-of-contents__link toc-highlight">Нестабильные списки</a></li><li><a href="#нестабильные-лямбды" class="table-of-contents__link toc-highlight">Нестабильные лямбды</a></li></ul></li><li><a href="#cpu-profiling" class="table-of-contents__link toc-highlight">CPU Profiling</a><ul><li><a href="#flame-chart" class="table-of-contents__link toc-highlight">Flame Chart</a></li><li><a href="#применение-2" class="table-of-contents__link toc-highlight">Применение</a></li><li><a href="#оптимизация-compose" class="table-of-contents__link toc-highlight">Оптимизация Compose</a></li><li><a href="#system-trace" class="table-of-contents__link toc-highlight">System Trace</a></li></ul></li><li><a href="#gpu-profiling" class="table-of-contents__link toc-highlight">GPU Profiling</a></li><li><a href="#полезные-ссылки" class="table-of-contents__link toc-highlight">Полезные ссылки</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">IceRock Development</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Site</a></li><li class="footer__item"><a href="https://github.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li><li class="footer__item"><a href="https://www.facebook.com/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook</a></li><li class="footer__item"><a href="https://vk.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">VK</a></li><li class="footer__item"><a href="https://www.instagram.com/icerockdevelopment" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UC-Vhmm09W_IWKHhSg80d68w" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li><li class="footer__item"><a href="https://twitter.com/icerockdev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter @icerockdev<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/kotlinmpp" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram @kotlinmpp<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/kotlinmppchats" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram @kotlinmppchats<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://kotlinlang.org/lp/mobile" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Mobile<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://libs.kmp.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Libs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://codelabs.kmp.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Codelabs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://moko.icerock.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">MOKO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/docs/reference/native-overview.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin/Native Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kotlinlang.org/docs/reference/multiplatform.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kotlin Multiplatform Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 IceRock Development. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7e89d3fd.js"></script>
<script src="/assets/js/main.df54c0e6.js"></script>
</body>
</html>